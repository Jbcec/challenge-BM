<div class="trial-detail-container">
  <div class="detail-header">
    <button mat-icon-button (click)="goBack()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>Trial Details</h1>
    <button mat-icon-button
            (click)="toggleFollow()"
            [title]="isFollowed() ? 'Unfollow trial' : 'Follow trial'"
            class="follow-btn">
      <mat-icon [class.followed]="isFollowed()">
        {{isFollowed() ? 'star' : 'star_border'}}
      </mat-icon>
    </button>
  </div>

  <div class="loading-container" *ngIf="loading$ | async">
    <mat-spinner></mat-spinner>
    <p>Loading trial details...</p>
  </div>

  <div class="detail-content" *ngIf="trialDetail$ | async as trialDetail; else noTrialData">

    <mat-card class="basic-info-card">
      <mat-card-header>
        <mat-card-title>{{trialDetail.title}}</mat-card-title>
        <mat-card-subtitle>{{trialDetail.nctId}}</mat-card-subtitle>
      </mat-card-header>

      <mat-card-content>
        <div class="info-grid">
          <div class="info-item">
            <label>Status:</label>
            <div class="status-container">
              <app-status-indicator [status]="trialDetail.status"></app-status-indicator>
              <span>{{trialDetail.status}}</span>
            </div>
          </div>

          <div class="info-item">
            <label>Phase:</label>
            <mat-chip class="phase-chip">{{trialDetail.phase}}</mat-chip>
          </div>

          <div class="info-item">
            <label>Condition:</label>
            <span>{{trialDetail.condition}}</span>
          </div>

          <div class="info-item">
            <label>Sponsor:</label>
            <span>{{trialDetail.sponsor}}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="description-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>description</mat-icon>
          Study Description
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <p>{{trialDetail.description}}</p>
      </mat-card-content>
    </mat-card>

    <mat-card class="eligibility-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>checklist</mat-icon>
          Eligibility Criteria
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="eligibility-content">
          {{trialDetail.eligibility}}
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="timeline-card" *ngIf="trialDetail.timeline">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>timeline</mat-icon>
          Study Timeline
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="timeline-container">
          <div class="timeline-item" *ngIf="trialDetail.timeline.studyFirstSubmitDate">
            <div class="timeline-marker first-submit"></div>
            <div class="timeline-content">
              <div class="timeline-title">Study First Submitted</div>
              <div class="timeline-date">{{formatDate(trialDetail.timeline.studyFirstSubmitDate)}}</div>
            </div>
          </div>

          <div class="timeline-item" *ngIf="trialDetail.timeline.studyFirstPostDate">
            <div class="timeline-marker first-post"></div>
            <div class="timeline-content">
              <div class="timeline-title">Study First Posted</div>
              <div class="timeline-date">{{formatDate(trialDetail.timeline.studyFirstPostDate)}}</div>
            </div>
          </div>

          <div class="timeline-item" *ngIf="trialDetail.timeline.startDate">
            <div class="timeline-marker start-date"></div>
            <div class="timeline-content">
              <div class="timeline-title">Study Start Date</div>
              <div class="timeline-date">{{formatDate(trialDetail.timeline.startDate)}}</div>
            </div>
          </div>

          <div class="timeline-item" *ngIf="trialDetail.timeline.statusVerifiedDate">
            <div class="timeline-marker verified"></div>
            <div class="timeline-content">
              <div class="timeline-title">Status Verified</div>
              <div class="timeline-date">{{formatDate(trialDetail.timeline.statusVerifiedDate)}}</div>
            </div>
          </div>

          <div class="timeline-item" *ngIf="trialDetail.timeline.lastUpdatePostDate">
            <div class="timeline-marker last-update"></div>
            <div class="timeline-content">
              <div class="timeline-title">Last Update Posted</div>
              <div class="timeline-date">{{formatDate(trialDetail.timeline.lastUpdatePostDate)}}</div>
            </div>
          </div>

          <div class="timeline-item" *ngIf="trialDetail.timeline.primaryCompletionDate">
            <div class="timeline-marker primary-completion"></div>
            <div class="timeline-content">
              <div class="timeline-title">Primary Completion Date</div>
              <div class="timeline-date">{{formatDate(trialDetail.timeline.primaryCompletionDate)}}</div>
            </div>
          </div>

          <div class="timeline-item" *ngIf="trialDetail.timeline.completionDate">
            <div class="timeline-marker completion"></div>
            <div class="timeline-content">
              <div class="timeline-title">Study Completion Date</div>
              <div class="timeline-date">{{formatDate(trialDetail.timeline.completionDate)}}</div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="locations-card" *ngIf="trialDetail.locations && trialDetail.locations.length > 0">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>location_on</mat-icon>
          Study Locations
        </mat-card-title>
      </mat-card-header>

      <mat-card-content>
        <div class="locations-list">
          <div *ngFor="let location of trialDetail.locations" class="location-item">
            <mat-icon>place</mat-icon>
            <div class="location-info">
              <div class="facility-name">{{location.facility || 'Facility name not available'}}</div>
              <div class="location-address">
                {{location.city}}, {{location.state}} {{location.zip}}
                <span *ngIf="location.country">, {{location.country}}</span>
              </div>
            </div>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div class="actions-section">
      <button mat-raised-button color="primary" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Back to Trials List
      </button>

      <button mat-raised-button
              [color]="isFollowed() ? 'warn' : 'accent'"
              (click)="toggleFollow()">
        <mat-icon>{{isFollowed() ? 'star' : 'star_border'}}</mat-icon>
        {{isFollowed() ? 'Unfollow' : 'Follow'}} Trial
      </button>
    </div>
  </div>

  <ng-template #noTrialData>
    <div class="no-data">
      <mat-icon>error_outline</mat-icon>
      <h3>Trial not found</h3>
      <p>The requested trial could not be found or loaded.</p>
      <button mat-raised-button color="primary" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Back to Trials List
      </button>
    </div>
  </ng-template>
</div>
